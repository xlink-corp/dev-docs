# 产品碳足迹（PCF）用户手册

> 文档目的：指导用户在系统内完成产品碳足迹（PCF）评估的产品/版本管理、BOM 配置、评估计算、结果查看与报告导出。

## 目录

- [1. 模块概述](#1-模块概述)
  - [1.1 功能定位](#11-功能定位)
  - [1.2 菜单页一览](#12-菜单页一览)
  - [1.3 核心概念](#13-核心概念)
  - [1.4 前置准备（仅说明）](#14-前置准备仅说明)
- [2. 快速入门（场景化）](#2-快速入门场景化)
  - [场景 A：从 0 完成一次 PCF 评估并导出报告](#场景-a从-0-完成一次-pcf-评估并导出报告)
  - [场景 B：发现“未匹配因子”并修正后重算](#场景-b发现未匹配因子并修正后重算)
  - [场景 C：批量维护 BOM（导入/导出）](#场景-c批量维护-bom导入导出)
- [3. 功能模块详解](#3-功能模块详解)
  - [3.1 PCF 产品管理（/pcf-products）](#31-pcf-产品管理pcf-products)
  - [3.2 BOM 配置（/pcf-bom-editor）](#32-bom-配置pcf-bom-editor)
  - [3.3 生命周期阶段（/pcf-lifecycle-stages）](#33-生命周期阶段pcf-lifecycle-stages)
  - [3.4 PCF 评估（/pcf-assessments）](#34-pcf-评估pcf-assessments)
  - [3.5 评估详情（/pcf-assessments/:assessmentId）](#35-评估详情pcf-assessmentsassessmentid)
  - [3.6 PCF 报告（/pcf-reports）](#36-pcf-报告pcf-reports)
- [4. 常见问题（FAQ）](#4-常见问题faq)
- [5. 附录](#5-附录)
  - [5.1 状态字典与按钮](#51-状态字典与按钮)
  - [5.2 术语表](#52-术语表)
  - [5.3 BOM 常用字段说明](#53-bom-常用字段说明)
- [版本更新记录](#版本更新记录)

---

## 1. 模块概述

### 1.1 功能定位

产品碳足迹（Product Carbon Footprint, PCF）模块用于：

1. 管理启用 PCF 的产品及其版本（配方/产地/工艺差异等）。
2. 维护产品版本的 BOM（物料清单），作为活动数据归属的重要来源。
3. 创建 PCF 评估，归集活动数据并运行计算。
4. 查看结果（阶段汇总、排放明细、热点 Top5）。
5. 导出 Excel/PDF 报告，用于内部评审或外部提交。

### 1.2 菜单页一览

| 菜单 | 路径 | 说明 |
|---|---|---|
| PCF产品管理 | `/pcf-products` | 管理启用 PCF 的产品版本；支持导入/导出 |
| BOM配置 | `/pcf-bom-editor` | 选择产品版本进入 BOM 编辑；支持导入/导出 |
| 生命周期阶段 | `/pcf-lifecycle-stages` | ISO 14067 生命周期阶段（上游/核心/下游）配置展示 |
| PCF评估 | `/pcf-assessments` | 创建/管理评估；进入评估详情进行计算与导出 |
| PCF报告 | `/pcf-reports` | 从评估列表中筛选并导出报告（Excel/PDF） |

> 评估详情页：从“PCF评估”列表点击任一评估进入：`/pcf-assessments/:assessmentId`。

### 1.3 核心概念

- **产品版本**：同一产品的不同 PCF 版本（例如不同配方/工艺/厂区），是 BOM 和评估的基础对象。
- **功能单位（FU, Functional Unit）**：用于表达单位产品的碳足迹口径，例如 “1 件 / 1 kg / 1 吨”。
- **BOM（物料清单）**：定义每功能单位的物料构成（用量、单位、外购/自制、供应商等）。
- **生命周期阶段（ISO 14067）**：上游/核心/下游及其阶段代码，用于排放归类与汇总。
- **活动数据**：评估中归集的输入数据（可来自 BOM、活动记录或手动录入），需匹配排放因子才能参与计算。
- **排放因子匹配**：若活动数据未匹配到排放因子，会提示“未匹配因子”，该数据不参与排放计算。
- **总排放/单位排放**：总排放量（kg CO₂e）与单位产品碳足迹（kg CO₂e / FU）。

### 1.4 前置准备（仅说明）

1. **产品已启用 PCF**：仅“启用 PCF”的产品会出现在 PCF 产品版本相关页面（例如 `/pcf-products` 统计与创建列表）。
2. **功能单位口径已配置**：评估详情会展示 `kg CO₂e / {functional_unit_text}`；BOM 页也会展示“每功能单位用量”。
3. **主数据准备**：建议预先维护物质类型、供应商、排放因子/活动数据等（用于后续匹配与计算）。

---

## 2. 快速入门（场景化）

### 场景 A：从 0 完成一次 PCF 评估并导出报告

1. 进入 **PCF产品管理**：`/pcf-products` → 点击 **创建产品版本**。
2. 在版本列表中找到目标版本：
   - 点击行进入编辑，或在“操作”里选择 **编辑BOM** 进入 BOM 页面。
3. 进入 **BOM 配置**：`/pcf-bom-editor/:versionId` → 点击 **添加物料**，补齐产品构成。
4. 进入 **PCF 评估**：`/pcf-assessments` → 点击 **创建评估**，选择产品版本并保存。
5. 进入评估详情：`/pcf-assessments/:assessmentId`：
   - 在 **活动数据** Tab 中点击 **添加活动数据**，把活动数据归属到生命周期阶段并配置归属比例。
   - 点击 **运行计算**。
6. 结果核对：
   - 在 **概览**查看总排放、热点 Top5。
   - 在 **阶段汇总**查看各生命周期阶段贡献。
   - 在 **排放明细**查看计算后的明细记录。
7. 导出报告：点击 **导出报告**，选择 Excel 或 PDF 并导出。

### 场景 B：发现“未匹配因子”并修正后重算

1. 打开评估详情页，如果看到 **数据完整性警告**：
   - 提示存在“未匹配到排放因子”的活动数据。
2. 点击 **查看问题数据** → 自动切换到 **活动数据** Tab 并开启“只看异常”。
3. 对每条“未匹配因子”数据：
   - 点击提示中的 **点击配置**（会跳转到 `/carbon-factors`），补齐/修正排放因子配置；
   - 返回评估详情，确认异常条数减少。
4. 重新点击 **运行计算**，再核对汇总与明细。

### 场景 C：批量维护 BOM（导入/导出）

1. 进入 BOM 编辑页：`/pcf-bom-editor/:versionId`。
2. 点击 **导出**：获得当前版本的 BOM 文件，适合离线维护与审阅。
3. 点击 **导入**：上传整理后的 BOM 文件，完成批量更新。

---

## 3. 功能模块详解

### 3.1 PCF 产品管理（/pcf-products）

#### 页面用途

管理启用 PCF 的产品版本（创建/编辑/删除），并提供版本导入/导出。

#### 主要操作

1. **导出**：点击页面右上角 **导出**。
2. **导入**：点击页面右上角 **导入**，按导入弹窗提示完成。
3. **创建产品版本**：点击 **创建产品版本**。
4. **编辑版本**：
   - 点击版本行（可直接进入编辑弹窗），或
   - “操作”菜单点击 **编辑版本**。
5. **进入 BOM 编辑**：在“操作”菜单点击 **编辑BOM**。
6. **删除版本**：在“操作”菜单点击 **删除**。

#### 字段/显示说明

- **产品**：显示产品名称（与编码）。
- **版本号**：`version_code`。
- **有效期**：`valid_from ~ valid_to`；缺省时显示 `-` 或“长期”。
- **状态**：**有效/无效**（根据 `is_active`）。

#### 注意事项

- 删除产品版本会提示：**相关 BOM 数据和评估记录也将被删除**，且不可撤销。
- 若产品未启用 PCF，可能不会计入“PCF产品”统计，也无法按预期创建版本。

---

### 3.2 BOM 配置（/pcf-bom-editor）

#### 页面用途

为产品版本维护 BOM（物料清单），定义每功能单位的物料构成。

#### 页面结构

1. **版本选择页**（未带 versionId）：`/pcf-bom-editor`
   - 支持按产品分组展开版本，搜索产品/版本号，按“有效/无效”筛选。
2. **BOM 编辑页**（带 versionId）：`/pcf-bom-editor/:versionId`
   - 显示版本信息、统计卡片、BOM 列表与批量操作。

#### 主要操作（BOM 编辑页）

1. **添加物料**：点击右上角 **添加物料**。
2. **编辑/复制/删除单条**：在“操作”菜单中选择 **编辑 / 复制 / 删除**。
   - 复制会生成“(副本)”物料项。
3. **批量删除**：
   - 勾选列表左侧复选框 → 点击顶部 **删除（n）** → 确认。
4. **导出**：点击 **导出**。
5. **导入**：点击 **导入**，在弹窗中上传文件并按提示完成。

#### 关键字段说明

- **物料名称**：`item_name`。
- **物质类型**：用于排放因子匹配与分类。
- **每功能单位用量**：`quantity_per_fu`（核心口径）。
- **单位**：`unit`。
- **类型**：**外购/自制**（`is_purchased`）。
- **供应商**：外购物料建议维护供应商以便后续供应链数据管理。

#### 注意事项

- “功能单位”会在页面顶部版本信息中显示（例如 `1 {unit}`），BOM 用量默认以“每功能单位”解释。
- 列表为空时会提示“暂无物料项”，需先添加物料后才能形成可复用的 BOM。

---

### 3.3 生命周期阶段（/pcf-lifecycle-stages）

#### 页面用途

展示 ISO 14067 生命周期阶段配置，按 **上游/核心/下游** 三类汇总与列表展示。

#### 主要内容

- 分类统计卡片：上游阶段、核心阶段、下游阶段（展示阶段数量）。
- 生命周期阶段列表：阶段序号、阶段代码、名称（中/英）、类别、描述、状态（启用/停用）。

#### 注意事项

- 生命周期阶段用于评估中活动数据归类与结果汇总。
- 在不同边界类型下，允许归类的阶段范围可能不同（例如 Gate-to-Gate 仅核心）。

---

### 3.4 PCF 评估（/pcf-assessments）

#### 页面用途

创建与管理 PCF 评估，支持按状态筛选、搜索，并进入评估详情进行计算。

#### 主要操作

1. **创建评估**：点击右上角 **创建评估**。
2. **查看详情**：点击评估行 → 进入 `/pcf-assessments/:assessmentId`。
3. **编辑**：在“操作”菜单点击 **编辑**。
4. **删除**：在“操作”菜单点击 **删除**。

#### 列表字段说明

- **评估名称**：`assessment_name`。
- **产品/版本**：产品名称 + 版本号。
- **评估类型**：基准评估/场景分析/客户定制。
- **边界**：摇篮到大门 / 大门到大门 /（其他边界按系统配置）。
- **总排放**：若已计算显示 `xx kg CO₂e`，否则为 `-`。
- **状态**：草稿/计算中/审核中/已批准/已归档。

#### 注意事项

- 删除评估会提示：相关活动数据和排放记录也将被删除，且不可撤销。

---

### 3.5 评估详情（/pcf-assessments/:assessmentId）

#### 页面用途

在评估详情中完成：活动数据归集、计算、核对结果、状态流转与报告导出。

#### 顶部按钮区（常用）

- **导出报告**：当总排放量为 0 时会被禁用（需先有计算结果）。
- **运行计算**：仅在 **草稿（draft）** 状态可用，且需要存在活动数据。
- **状态流转按钮**：根据当前状态显示（见 [5.1 状态字典与按钮](#51-状态字典与按钮)）。

#### 数据完整性警告

当存在“未匹配因子”的活动数据时，页面顶部会出现 **数据完整性警告**：

- 提示：未匹配因子的数据无法参与排放计算。
- 操作：点击 **查看问题数据**，跳转到“活动数据”Tab 并开启“只看异常”。

#### Tabs 说明

1. **概览**
   - 指标卡片：总排放量、边界类型、活动数据条数、排放记录条数。
   - 可视化：排放热点 Top 5、生命周期阶段分布、类别汇总、能源类型排放分布（如有数据）。
2. **阶段汇总**
   - 展示各生命周期阶段排放汇总（含贡献占比）。
3. **排放明细**
   - 展示计算得出的排放记录明细（用于追溯与核对）。
4. **活动数据**
   - 搜索：支持按阶段、对象名称、排放源、物质类型、因子名称、数据来源等检索。
   - 只看异常：按钮 **只看异常（n）**，用于聚焦未匹配因子数据。
   - 添加：**添加活动数据**（草稿状态可用）。
   - 编辑/删除：每条记录右侧按钮（草稿状态可用）。
   - 因子配置跳转：未匹配因子时可点 **点击配置** → 跳转 `/carbon-factors`。

#### 注意事项

- **建议的操作顺序**：先补齐活动数据并确保匹配到排放因子，再运行计算。
- **草稿以外的状态**：通常会限制编辑与删除（页面按钮会禁用），请按状态流转进行处理。

---

### 3.6 PCF 报告（/pcf-reports）

#### 页面用途

从评估列表中筛选目标评估并导出报告（Excel/PDF）。

#### 主要操作

1. 搜索/筛选：支持按评估名称、产品搜索；按状态筛选（草稿/计算中/审核中/已批准/已归档）。
2. 导出：点击某条评估右侧 **导出**。
   - 若评估尚未产生 `total_emissions`，导出按钮会被禁用。

#### 导出说明（与系统一致）

- **Excel**：多工作表，适合内部分析；常见包含：报告概览、生命周期阶段、（可选）能源类型排放、（可选）排放明细、（可选）方法学。
- **PDF**：适合正式提交；包含封面、基本信息、阶段汇总、（可选）能源类型排放、（可选）Top 排放源、（可选）方法学。

---

## 4. 常见问题（FAQ）

1. **为什么在“PCF产品管理”里看不到产品？**
   - 检查产品是否已启用 PCF（仅作为前置条件，本手册不展开配置步骤）。

2. **“运行计算”按钮不可用/点击无结果？**
   - 评估不是草稿（draft）状态；或
   - 活动数据条数为 0；或
   - 活动数据虽存在但未匹配排放因子，导致无法形成有效排放记录。

3. **页面提示“未匹配因子”，怎么处理？**
   - 在评估详情 → 活动数据 → 点击 **点击配置** 跳转到 `/carbon-factors` 补齐排放因子；返回后重算。

4. **为什么“导出报告”按钮是灰的？**
   - 评估总排放量为 0（未计算或无有效排放记录）。

5. **删除评估/版本会影响什么？**
   - 删除版本：会删除相关 BOM 和评估记录（不可撤销）。
   - 删除评估：会删除相关活动数据与排放记录（不可撤销）。

---

## 5. 附录

### 5.1 状态字典与按钮

| 状态 | 状态含义 | 详情页可见按钮（与页面一致） |
|---|---|---|
| 草稿（draft） | 可编辑数据、可计算 | 运行计算、提交审核、导出报告（需有结果） |
| 计算中（calculating） | 计算进行中/过渡状态 | （视页面实现）一般不建议操作 |
| 审核中（under_review） | 待审核确认 | 批准通过、驳回修改、导出报告（需有结果） |
| 已批准（approved） | 评估结果已确认 | 归档、导出报告 |
| 已归档（archived） | 历史版本留存 | 取消归档、导出报告 |

> 说明：
> - **提交审核**：提交后系统提示“提交后将无法修改数据”。
> - **驳回修改**：将评估退回草稿（draft）。
> - **归档/取消归档**：用于管理历史版本与可追溯性。

### 5.2 术语表

- **PCF**：Product Carbon Footprint，产品碳足迹。
- **CO₂e**：二氧化碳当量。
- **FU**：Functional Unit，功能单位。
- **ISO 14067**：产品碳足迹量化与报告的国际标准之一。

### 5.3 BOM 常用字段说明

- **每功能单位用量（quantity_per_fu）**：BOM 的核心口径字段，用于表达“单位产品（FU）消耗多少物料”。
- **外购/自制（is_purchased）**：用于区分供应链数据来源与边界归类。
- **供应商（supplier）**：建议在外购物料维护，便于供应链排放数据跟踪。

---

## 版本更新记录

| 版本 | 日期 | 更新内容 |
|---|---|---|
| v1.0 | 2026-01 | 新增“产品碳足迹（PCF）”用户手册，覆盖产品/版本、BOM、评估、详情与报告导出 |
