# 能流与平衡 用户手册

> 本手册适用于需要配置能源流向网络、查看能源平衡分析、进行能量守恒校验的用户。

---

## 一、模块概述

### 1.1 能流与平衡是什么

能流与平衡模块用于建立能源流向网络模型，可视化能源从输入源头到终端消费的流动路径，并进行能量守恒校验与损耗分析。通过该模块，您可以：

- 构建能源流向拓扑结构
- 直观展示能源分布（Sankey 图）
- 验证各节点能量输入输出平衡
- 识别系统损耗点和数据异常

### 1.2 核心功能模块

| 功能 | 说明 |
|------|------|
| 能流配置 | 配置能流节点（源头/分配/转换/消费）和路径拓扑 |
| 能源平衡 | Sankey 图可视化能源流向分布 |
| 能量守恒校验 | 检验各节点的能量输入输出平衡 |

### 1.3 用户角色

| 角色 | 主要职责 | 常用功能 |
|------|----------|----------|
| 能流与平衡员 | 配置能流网络、分析平衡状态 | 全部功能 |
| 运维工程师 | 监控能源流向、定位损耗点 | 能源平衡、守恒校验 |
| 管理层 | 了解能源使用概况 | Sankey 可视化 |

---

## 二、快速入门

### 场景 1：首次建立能流网络

**前置条件**：已完成能源类型配置、计量表配置、用能对象配置

1. 进入「能流与平衡」→「能流配置」
2. 切换到「拓扑结构」Tab
3. 点击工具栏「+」按钮添加源头节点（关联能源源头）
4. 继续添加分配/转换/消费节点
5. 从节点端口拖拽连线到目标节点创建路径
6. 系统自动保存拓扑结构

### 场景 2：查看能源流向分布

1. 进入「能流与平衡」→「能源平衡」
2. 选择时间范围（默认近 30 天）
3. 查看 Sankey 图中能源从源头到终端的流动
4. 点击节点或连线查看详细信息
5. 使用工具栏缩放、导出图片

### 场景 3：检查能量不平衡问题

1. 进入「能流与平衡」→「能量守恒校验」
2. 查看 KPI 卡片：校验节点总数、平衡节点、警告节点、错误节点
3. 点击「错误」卡片筛选问题节点
4. 点击节点行打开详情抽屉
5. 查看入流/出流路径明细，定位数据缺失或配置问题

---

## 三、功能详解

### 3.1 能流配置

**入口**：能流与平衡 → 能流配置

**解决什么问题**：建立能源流向的拓扑网络模型，定义能源如何从输入点流向消费终端。

#### 3.1.1 拓扑结构 Tab

可视化能流网络图，支持拖拽操作节点和路径。

**画布操作**：

| 操作 | 方式 |
|------|------|
| 创建节点 | 点击工具栏「+」按钮 |
| 创建路径 | 从节点端口拖拽连线到目标节点 |
| 选择节点 | 单击节点，支持多选（框选或 Shift+点击） |
| 编辑节点 | 双击节点打开编辑对话框 |
| 删除节点/路径 | 选中后按 Delete 键或右键菜单 |
| 移动节点 | 拖拽节点到新位置（自动保存） |
| 缩放平移 | 滚轮缩放、拖拽画布平移 |
| 重置布局 | 工具栏「重置布局」按钮 |
| 刷新数据 | 工具栏「刷新」按钮 |

**校验提示**：画布自动检测孤立节点和层级违规，显示警告标识。

#### 3.1.2 节点管理 Tab

列表管理所有能流节点。

**节点类型**：

| 类型 | 说明 | 颜色 | 典型用途 |
|------|------|------|----------|
| 源头节点 | 能源输入点 | 🟢 绿色 | 电网入口、锅炉、空压站 |
| 分配节点 | 能源分配点 | 🔵 蓝色 | 配电柜、分水器、母线 |
| 转换节点 | 能源转换点 | 🟣 紫色 | 冷水机组、变压器、空压机 |
| 消费节点 | 终端用能点 | 🟠 橙色 | 生产设备、空调区域、照明 |

**关联实体**：

- 源头节点 → 关联能源源头（energy_sources）
- 消费节点 → 关联用能对象或空间

**转换节点配置**：

| 配置项 | 说明 |
|--------|------|
| 转换效率 | 能源转换效率（如 95%） |
| 主输入能源类型 | 输入的能源类型（如电力） |
| 主输出能源类型 | 输出的能源类型（如冷量） |
| 辅助输入 | 可选，如冷水机需要电+水 |

#### 3.1.3 路径管理 Tab

列表管理所有能流路径（边）。

**路径数据来源类型**：

| 类型 | 说明 | 颜色 | 适用场景 |
|------|------|------|----------|
| 计量表 | 实测数据 | 🔵 蓝色 | 有独立计量表的路径 |
| 用能对象 | 聚合数据 | 🟠 橙色 | 通过用能对象关联的多表汇总 |
| 分摊比例 | 规则分配 | 🟢 绿色 | 无计量表，按比例分摊上游能量 |
| 公式计算 | 数学推导 | 🟣 紫色 | 自定义公式计算（如差值法） |

**关键字段**：

| 字段 | 说明 |
|------|------|
| 源节点 | 能量流出的节点 |
| 目标节点 | 能量流入的节点 |
| 能源类型 | 该路径传输的能源类型 |
| 数据来源类型 | 计量表/用能对象/分摊比例/公式 |
| 配置详情 | 根据类型不同显示具体配置 |

---

### 3.2 能源平衡（Sankey 可视化）

**入口**：能流与平衡 → 能源平衡

**解决什么问题**：直观展示能源从输入到终端的流动分布，识别能源损耗点。

#### 页面组成

**1. KPI 卡片**

| 指标 | 说明 | 图标 |
|------|------|------|
| 总输入能量 | 从源头流入系统的总能量 | ↘️ |
| 有效输出 | 流入终端消费的总能量 | ↗️ |
| 能源损耗 | 总输入 - 总输出 | 🔥 |
| 能源效率 | 有效输出 / 总输入 × 100% | ⚡ |

**2. Sankey 图**

- 节点按层级从左到右排列：源头 → 分配 → 转换 → 消费
- 连线宽度表示能量大小
- 颜色编码：
  - 实线彩色：有数据的路径
  - 灰色虚线：已配置但暂无数据的路径
- 交互操作：
  - 点击节点：查看节点详情（名称、类型、总能量）
  - 点击连线：查看路径详情（源→目标、能量值、占比）
  - 滚轮：缩放画布
  - 拖拽：平移画布

**3. 工具栏**

| 按钮 | 功能 |
|------|------|
| 🔍+ | 放大 |
| 🔍- | 缩小 |
| ↺ | 重置视图 |
| ⛶ | 全屏显示 |
| 📥 | 导出图片（PNG/SVG） |

**4. 筛选功能**

| 筛选项 | 说明 |
|--------|------|
| 时间范围 | 选择统计周期（日/周/月/自定义） |
| 能源类型 | 筛选特定能源类型 |
| 节点筛选 | 选择特定节点，自动追溯上下游 |

**单位切换**：

| 模式 | 显示单位 | 适用场景 |
|------|----------|----------|
| 多能源混合 | 标准煤（kgce/tce） | 综合能耗分析 |
| 单一能源 | 原始单位（kWh、m³等） | 特定能源分析 |

---

### 3.3 能量守恒校验

**入口**：能流与平衡 → 能量守恒校验

**解决什么问题**：检验能流网络中各节点的能量输入与输出是否平衡，发现数据异常或配置问题。

#### 页面组成

**1. KPI 卡片**（可点击筛选）

| 指标 | 说明 | 颜色 |
|------|------|------|
| 校验节点总数 | 参与校验的节点数量 | 蓝色 |
| 平衡节点 | 误差率 ≤ 2% 的节点 | 绿色 |
| 警告节点 | 误差率 2% ~ 4% 的节点 | 黄色 |
| 错误节点 | 误差率 > 4% 的节点 | 红色 |

**2. 校验结果列表**

| 列 | 说明 |
|------|------|
| 节点名称 | 节点标识 |
| 节点类型 | 源头/分配/转换/消费（带颜色标识） |
| 入流 | 流入该节点的总能量 |
| 出流 | 流出该节点的总能量 |
| 损耗 | 入流 - 出流（仅适用于中间节点） |
| 差值 | 能量不平衡值 |
| 误差率 | 损耗/入流 |
| 状态 | ✅ 平衡 / ⚠️ 警告 / ❌ 错误 |

**3. 节点详情抽屉**

点击列表行打开详情抽屉，包含：

| 区域 | 内容 |
|------|------|
| 校验汇总 | 入流/出流/损耗/误差率一览 |
| 守恒公式 | 入流 = 出流 + 损耗（可视化展示） |
| 转换效率 | 转换节点显示：配置效率 vs 实际效率 |
| 入流路径表 | 所有入流边的数据来源和数值明细 |
| 出流路径表 | 所有出流边的数据来源和数值明细 |
| 单位切换 | 标准煤 / 原始单位 |

**4. 筛选功能**

| 筛选项 | 说明 |
|--------|------|
| 时间范围 | 选择统计周期 |
| 能源类型 | 筛选特定能源类型 |
| 节点筛选 | 选择特定节点 |
| 状态 Tab | 全部 / 平衡 / 警告 / 错误 |

**5. 导出功能**

支持导出 Excel 报表，包含所有校验结果。

---

## 四、核心流程图解

### 能流配置建立顺序

```
┌─────────────────────────────────────────────────────────────┐
│  1. 创建源头节点（关联能源源头）                              │
│     ↓                                                       │
│  2. 创建分配节点（如配电柜、母线）                            │
│     ↓                                                       │
│  3. 创建转换节点（如冷水机组、变压器）                        │
│     ↓                                                       │
│  4. 创建消费节点（关联用能对象/空间）                         │
│     ↓                                                       │
│  5. 通过路径连接节点（选择数据来源类型）                      │
│     ↓                                                       │
│  6. 验证拓扑结构（检查孤立节点和层级违规）                    │
└─────────────────────────────────────────────────────────────┘
```

### 守恒校验公式

```
守恒公式：入流 = 出流 + 损耗

误差计算：误差率 = |差值| / 入流 × 100%

状态判定：
┌────────────────────────────────────┐
│  误差率 ≤ 2%    →  ✅ 平衡         │
│  误差率 2% ~ 4% →  ⚠️ 警告         │
│  误差率 > 4%    →  ❌ 错误         │
└────────────────────────────────────┘
```

### 边界节点特殊处理

| 节点类型 | 特殊情况 | 说明 |
|----------|----------|------|
| 源头节点 | 入流 = 0 | 正常，能源从此输入系统 |
| 消费节点 | 出流 = 0 | 正常，能源在此被消耗 |

---

## 五、常见问题（FAQ）

### Q1: Sankey 图中为什么有灰色虚线？

**A**: 灰色虚线表示该路径已配置但暂无能耗数据。请检查：
- 关联的计量表是否正常采集数据
- 时间范围是否覆盖有数据的时段
- 用能对象是否已绑定计量表

### Q2: 节点显示为「孤立节点」怎么办？

**A**: 该节点未连接任何路径。解决方法：
1. 进入「能流配置」→「拓扑结构」
2. 找到孤立节点（会有警告标识）
3. 从该节点端口拖拽连线到其他节点

### Q3: 守恒校验误差率过高怎么排查？

**A**: 按以下步骤排查：
1. 点击节点行打开详情抽屉
2. 查看入流/出流路径表
3. 检查是否有路径显示「暂无数据」
4. 检查分摊比例配置是否正确（各路径比例之和应为 100%）
5. 检查是否有遗漏的路径未配置

### Q4: 如何配置转换节点的效率？

**A**: 
1. 进入「能流配置」→「节点管理」
2. 找到转换节点，点击编辑按钮
3. 展开「转换配置」区域
4. 设置效率（如 95%）和输入/输出能源类型
5. 保存

### Q5: 如何查看特定节点的上下游路径？

**A**: 使用节点筛选功能：
1. 在筛选面板中勾选目标节点
2. 系统自动追溯选中节点的上下游相关节点
3. Sankey 图和校验列表会只显示相关数据

### Q6: 能源平衡页面和守恒校验有什么区别？

**A**: 
| 页面 | 侧重点 | 适用场景 |
|------|--------|----------|
| 能源平衡 | 可视化全局流向 | 汇报展示、整体概况 |
| 守恒校验 | 逐节点数据校验 | 数据核查、问题定位 |

### Q7: 多种能源类型如何统一比较？

**A**: 系统自动将所有能源类型折算为标准煤（kgce/tce）进行统一比较。折算系数在「能源类型管理」中配置。

---

## 六、附录

### 6.1 术语表

| 术语 | 说明 |
|------|------|
| 能流节点 | 能源流动网络中的点，包括源头、分配、转换、消费四种类型 |
| 能流路径/边 | 节点间的连接，表示能源流动方向 |
| Sankey 图 | 一种流量图，用线条宽度表示数值大小 |
| 守恒校验 | 验证节点的能量输入与输出是否平衡 |
| 损耗 | 能量在流动过程中的消耗 |
| 误差阈值 | 判定平衡状态的允许误差范围，默认 2% |
| 标准煤 | 能源折算的统一计量单位，1 kWh ≈ 0.1229 kgce |
| 折标煤系数 | 将各种能源折算为标准煤的换算系数 |

### 6.2 标准煤换算参考

| 能源类型 | 换算系数 | 说明 |
|----------|----------|------|
| 电力 | 0.1229 kgce/kWh | 发电煤耗法 |
| 天然气 | 1.33 kgce/m³ | 按热值折算 |
| 蒸汽 | 0.1286 kgce/kg | 按焓值折算 |
| 柴油 | 1.4571 kgce/kg | 按热值折算 |

> 注：具体系数以「能源类型管理」中的配置为准

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | 2026-01 | 初始版本 |
